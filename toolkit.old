source ./toolkit.conf

touch ../selenium.yml
echo 'version: "3"'>>../selenium.yml
echo 'services:'>>../selenium.yml
echo '        selenium:'>>../selenium.yml
echo '                image: selenium/standalone-chrome'>>../selenium.yml
echo '                ports:'>>../selenium.yml
echo '                        - "4444:4444"'>>../selenium.yml
sudo yum update -y
sudo yum -y install php56-pecl-xdebug
sudo sed -i "/^;xdebug.remote_enable/axdebug.remote_enable = 1" /etc/php-5.6.d/15-xdebug.ini
sudo yum -y remove mysql-config mysql55-libs mysql55-server perl-DBD-MySQL55
sudo yum -y install mysql56-server
sudo yum -y install phpMyAdmin
docker swarm init
docker stack deploy -c ../selenium.yml selenium
sudo service mysqld start
sudo sed -i /^Listen/s/80/8080/ $HTTP  
sudo service httpd start
sudo curl -sS https://getcomposer.org/installer | sudo php
sudo mv composer.phar /usr/local/bin/composer
sudo ln -s /usr/local/bin/composer /usr/bin/composer
sudo sed -i /memory_limit/s/128M/512M/ /etc/php.ini 
for x in httpd mysqld;do sudo chkconfig $x on;done

#mkdir build
#sudo sed -i '/var\/www\/html/s/var\/www\/html/home\/ec2-user\/environment\/build/' $HTTP
#sudo sed -i "/var\/www/s/var\/www/home\/ec2-user\/environment/" $HTTP
#sudo sed -i "/User apache/s/apache/ec2-user/" $HTTP
#sudo sed -i "/Group apache/s/apache/ec2-user/" $HTTP
#sudo sed -i "/AllowOverride None/s/AllowOverride None/AllowOverride All/" $HTTP
#sudo sed -i "/AllowOverride none/s/AllowOverride none/AllowOverride All/" $HTTP
#sudo service httpd restart

git config --global user.name $USER
git config --global user.email $EMAIL
git clone https://github.com/ec-europa/$REPO.git

#################################################

mv $REPO/* .
mv $REPO/.* .
rmdir $REPO/
git checkout -b toolkit/upgrade
rm *
mkdir RESOURCES
mv resources/patches RESOURCES/
mv resources/site.make RESOURCES/
mv resources/composer.json RESOURCES/

rm -r docs/ resources/ src/ tests/
composer create-project ec-europa/subsite temp dev-master

#####################################################

mv temp/* .
rm -r temp/

mkdir lib/custom
mv lib/modules/* lib/custom/
mv lib/custom/features/ lib/features/
mv lib/custom lib/modules/
mv lib/features lib/modules/
mv RESOURCES/* resources/
rmdir RESOURCES

echo "project.url.base = https://$ENVIRONMENT_ID.vfs.cloud9.$REGION_ID.amazonaws.com">>$FILE
echo "project.url.production = $URL">>$FILE
echo "project.id = $SITE">>$FILE
echo "project.name = Subsite $SITE">>$FILE
echo "platform.package.version = $VERSION">>$FILE
echo "db.host = 127.0.0.1">>$FILE
echo "share.path = /tmp/cache">>$FILE
echo "phpcs.reports = full">>$FILE
echo "behat.formatter.name = pretty">>$FILE
echo "db.dl.password = $ASDA">>$FILE
echo 'db.dl.username = ${project.id}'>>$FILE
echo 'db.name = ${project.id}'>>$FILE
echo 'behat.base_url = ${project.url.base}'>>$FILE

##############################################

phing build-platform
rm resources/composer.lock
phing build-subsite-dev
phing install-clone

#############################################
#
#chmod u+w build/sites/default/
#cp build/sites/default/settings.php build/sites/default/settings.php.OLD
#sed -i '/ec2-user/s/\/home\/ec2-user\/environment\/build\///' build/sites/default/settings.php
#
#toolkit/drush -r build rr
#toolkit/drush -r build uli
#
#sudo service httpd restart
#
#############################################
#
#cd /home/ec2-user/environment/build
#../vendor/ec-europa/toolkit/bin/drush @none dl registry_rebuild-7.x
#../vendor/ec-europa/toolkit/bin/drush rr
#cat /home/ec2-user/environment/build/sites/all/drush/aliases.drushrc.php
#toolkit/phing drush-settings-generate
#toolkit/drush -r build status
#toolkit/drush -r build uli
#curl -u $SITE:$(awk /password/'{print $3}' $FILE) https://webgate.ec.europa.eu/fpfis/files-for/automate_dumps/$SITE/
#toolkit/drush -r build --color --db-url="mysql://root:@127.0.0.1:3306/spain" --yes sql-drop
#toolkit/drush -r build --color --db-url="mysql://root:@127.0.0.1:3306/spain" --yes sql-create
#toolkit/drush -r build --color php-script vendor/ec-europa/toolkit/includes/drush/generate-directories.php
#toolkit/drush -r build --color sql-cli < sanitized_daily_multisite_spain_production.sql
#
